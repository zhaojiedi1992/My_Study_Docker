<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>3. 服务</title>
    <link rel="stylesheet" href="../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" type="text/css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>3. 服务</h1>
<div class="section" id="id2">
<h2>3.1. 需要的环境</h2>
<ul class="simple">
<li><p>docker&gt;=1.13</p></li>
<li><p>docker compose</p></li>
<li><p>已经完成前面2个章节</p></li>
</ul>
</div>
<div class="section" id="docker-compose">
<h2>3.2. 安装docker compose</h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 配置k8s 仓库</span>
<span class="o">[</span>root@iZ2ze3vsekthy9vqtndzefZ yum.repos.d<span class="o">]</span><span class="c1"># cat kubernetes.repo</span>
<span class="o">[</span>kubernetes<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>Kubernetes
<span class="nv">baseurl</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
<span class="nv">repo_gpgcheck</span><span class="o">=</span><span class="m">0</span>
<span class="nv">gpgkey</span><span class="o">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
    http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg

<span class="c1"># 开始安装</span>
yum install docker-compose
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>默认k8s的仓库是google的，没法访问的。</p>
</div>
</div>
<div class="section" id="docker-compose-yml">
<h2>3.3. docker-compose.yml文件</h2>
<p>编辑一个docker-compose.yml文件，内容如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&quot;3&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
    <span class="c1"># replace username/repo:tag with your name and image details</span>
    <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zhaojiedi1992/helloworld:v1.0</span>
    <span class="l l-Scalar l-Scalar-Plain">deploy</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">limits</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">cpus</span><span class="p p-Indicator">:</span> <span class="s">&quot;0.1&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">50M</span>
    <span class="l l-Scalar l-Scalar-Plain">restart_policy</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">on-failure</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;4000:80&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">webnet</span>
<span class="l l-Scalar l-Scalar-Plain">networks</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">webnet</span><span class="p p-Indicator">:</span>
</pre></div>
</div>
</div>
<div class="section" id="app">
<h2>3.4. 运行一个负载均衡的app</h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;iZ2ze3vsekthy9vqtndzefZ">root<span>&#64;</span>iZ2ze3vsekthy9vqtndzefZ</a> docker]#  docker swarm init –advertise-addr 10.80.89.19</p>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;iZ2ze3vsekthy9vqtndzefZ">root<span>&#64;</span>iZ2ze3vsekthy9vqtndzefZ</a> docker]# docker stack deploy -c docker-compose.yml getstartedlab
Creating network getstartedlab_webnet
Creating service getstartedlab_web</p>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;iZ2ze3vsekthy9vqtndzefZ">root<span>&#64;</span>iZ2ze3vsekthy9vqtndzefZ</a> docker]# docker service ls
ID            NAME               MODE        REPLICAS  IMAGE
hf9hawqrchfq  getstartedlab_web  replicated  5/5       zhaojiedi1992/helloworld:v1.0</p>
<p>[<a class="reference external" href="mailto:root&#37;&#52;&#48;iZ2ze3vsekthy9vqtndzefZ">root<span>&#64;</span>iZ2ze3vsekthy9vqtndzefZ</a> docker]# docker service ps getstartedlab_web
ID            NAME                 IMAGE                          NODE                     DESIRED STATE  CURRENT STATE               ERROR  PORTS
pv5j41ap4btg  getstartedlab_web.1  zhaojiedi1992/helloworld:v1.0  iZ2ze3vsekthy9vqtndzefZ  Running        Running about a minute ago
rsvlvfa48sk6  getstartedlab_web.2  zhaojiedi1992/helloworld:v1.0  iZ2ze3vsekthy9vqtndzefZ  Running        Running about a minute ago
od33frib2yxs  getstartedlab_web.3  zhaojiedi1992/helloworld:v1.0  iZ2ze3vsekthy9vqtndzefZ  Running        Running about a minute ago
z2til8qa79k0  getstartedlab_web.4  zhaojiedi1992/helloworld:v1.0  iZ2ze3vsekthy9vqtndzefZ  Running        Running about a minute ago
29tnd4g7p8kj  getstartedlab_web.5  zhaojiedi1992/helloworld:v1.0  iZ2ze3vsekthy9vqtndzefZ  Running        Running about a minute ago</p>
</div>
<div class="section" id="id3">
<h2>3.5. 扩展应用程序</h2>
<p>修改docker-compose的集群数值，然后运行如下命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker stack deploy -c docker-compose.yml getstartedlab
</pre></div>
</div>
</div>
<div class="section" id="appswarm">
<h2>3.6. 关闭app和swarm</h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker stack rm getstartedlab
docker swarm leave --force
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>